<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Query.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Riak Client for Java</a> &gt; <a href="index.source.html" class="el_package">com.basho.riak.client.api.commands.timeseries</a> &gt; <span class="el_source">Query.java</span></div><h1>Query.java</h1><pre class="source lang-java linenums">package com.basho.riak.client.api.commands.timeseries;

import com.basho.riak.client.api.AsIsRiakCommand;
import com.basho.riak.client.core.operations.ts.QueryOperation;
import com.basho.riak.client.core.query.timeseries.QueryResult;
import com.basho.riak.client.core.util.BinaryValue;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Time Series Query Command
 * Allows you to query a Time Series table, with the given query string.
 *
 * @author Alex Moore &lt;amoore at basho dot com&gt;
 * @author Sergey Galkin &lt;srggal at gmail dot com&gt;
 * @since 2.0.3
 */
public class Query extends AsIsRiakCommand&lt;QueryResult, String&gt;
{
    private final Builder builder;

    private Query(Builder builder)
<span class="nc" id="L28">    {</span>
<span class="nc" id="L29">        this.builder = builder;</span>
<span class="nc" id="L30">    }</span>

    @Override
    protected QueryOperation buildCoreOperation()
    {
<span class="nc" id="L35">        return new QueryOperation.Builder(builder.queryText)</span>
<span class="nc" id="L36">                                           .withCoverageContext(builder.coverageContext)</span>
<span class="nc" id="L37">                                           .build();</span>
    }

    /**
     * Used to construct a Time Series Query command.
     */
    public static class Builder
    {
<span class="nc" id="L45">        private static final Logger logger = LoggerFactory.getLogger(Query.Builder.class);</span>
<span class="nc" id="L46">        private static final Pattern paramPattern = Pattern.compile(&quot;(:[a-zA-Z][0-9a-zA-Z_]*)&quot;);</span>

        private final String queryText;
<span class="nc" id="L49">        private final Map&lt;String, BinaryValue&gt; interpolations = new HashMap&lt;&gt;();</span>
        private final Set&lt;String&gt; knownParams;
<span class="nc" id="L51">        private byte[] coverageContext = null;</span>

        /**
         * Construct a Builder for a Time Series Query command.
         * @param queryText Required. The query to run.
         */
        public Builder(String queryText)
<span class="nc" id="L58">        {</span>
<span class="nc bnc" id="L59" title="All 4 branches missed.">            if (queryText == null || queryText.isEmpty())</span>
            {
<span class="nc" id="L61">                String msg = &quot;Query Text must not be null or empty&quot;;</span>
<span class="nc" id="L62">                logger.error(msg);</span>
<span class="nc" id="L63">                throw new IllegalArgumentException(msg);</span>
            }

<span class="nc" id="L66">            this.queryText = queryText;</span>

<span class="nc" id="L68">            Matcher paramMatcher = paramPattern.matcher(queryText);</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (!paramMatcher.matches())</span>
            {
<span class="nc" id="L72">                knownParams = Collections.emptySet();</span>
<span class="nc" id="L73">                return;</span>
            }

<span class="nc" id="L76">            knownParams = new HashSet&lt;&gt;(paramMatcher.groupCount());</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">            for (int i = 0; i &lt; paramMatcher.groupCount(); i++)</span>
            {
<span class="nc" id="L80">                knownParams.add(paramMatcher.group(i));</span>
            }
<span class="nc" id="L82">        }</span>

        public Builder(String queryText, byte[] coverageContext)
        {
<span class="nc" id="L86">            this(queryText);</span>
<span class="nc" id="L87">            this.coverageContext = coverageContext;</span>
<span class="nc" id="L88">        }</span>

        private Builder addParameter(String keyString, String key, BinaryValue value)
        {
<span class="nc" id="L92">            checkParamValidity(keyString);</span>
<span class="nc" id="L93">            interpolations.put(key, value);</span>
<span class="nc" id="L94">            return this;</span>
        }

        public Builder withCoverageContext(byte[] coverageContext)
        {
<span class="nc" id="L99">            this.coverageContext = coverageContext;</span>
<span class="nc" id="L100">            return this;</span>
        }

        private void checkParamValidity(String paramName)
        {
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if (!knownParams.contains(paramName))</span>
            {
<span class="nc" id="L107">                String msg = &quot;Unknown query parameter: &quot; + paramName;</span>
<span class="nc" id="L108">                logger.error(msg);</span>
<span class="nc" id="L109">                throw new IllegalArgumentException(msg);</span>
            }
<span class="nc" id="L111">        }</span>

        /**
         * Construct a Time Series Query object.
         * @return a new Time Series Query instance.
         */
        public Query build()
        {
<span class="nc" id="L119">            return new Query(this);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>