<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StoreBucketPropsOperation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Riak Client for Java</a> &gt; <a href="index.source.html" class="el_package">com.basho.riak.client.core.operations</a> &gt; <span class="el_source">StoreBucketPropsOperation.java</span></div><h1>StoreBucketPropsOperation.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013 Basho Technologies Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.basho.riak.client.core.operations;

import com.basho.riak.client.core.FutureOperation;
import com.basho.riak.client.core.RiakMessage;
import com.basho.riak.client.core.query.Namespace;
import com.basho.riak.client.core.query.functions.Function;
import com.basho.riak.protobuf.RiakMessageCodes;
import com.basho.riak.protobuf.RiakPB;
import com.google.protobuf.ByteString;
import java.util.List;

/**
 *
 * @author Brian Roach &lt;roach at basho dot com&gt;
 * @since 2.0
 */
//TODO: return some sort of &quot;success&quot; instead of Void
public class StoreBucketPropsOperation extends FutureOperation&lt;Void, Void, Namespace&gt;
{
    private final Namespace namespace;
    private final RiakPB.RpbSetBucketReq.Builder reqBuilder;

    private StoreBucketPropsOperation(Builder builder)
<span class="nc" id="L39">    {</span>
<span class="nc" id="L40">        this.reqBuilder = builder.reqBuilder;</span>
<span class="nc" id="L41">        this.namespace = builder.namespace;</span>
<span class="nc" id="L42">    }</span>

    @Override
    protected Void convert(List&lt;Void&gt; rawResponse)
    {
<span class="nc" id="L47">        return null;</span>
    }

    @Override
    protected RiakMessage createChannelMessage()
    {
<span class="nc" id="L53">        RiakPB.RpbSetBucketReq req = reqBuilder.build();</span>
<span class="nc" id="L54">        return new RiakMessage(RiakMessageCodes.MSG_SetBucketReq, req.toByteArray());</span>
    }

    @Override
    protected Void decode(RiakMessage rawMessage)
    {
<span class="nc" id="L60">        Operations.checkPBMessageType(rawMessage, RiakMessageCodes.MSG_SetBucketResp);</span>
<span class="nc" id="L61">        return null;</span>
    }

    @Override
    public Namespace getQueryInfo()
    {
<span class="nc" id="L67">        return namespace;</span>
    }

<span class="nc" id="L70">    static abstract class PropsBuilder&lt;T extends PropsBuilder&lt;T&gt;&gt;</span>
    {
<span class="nc" id="L72">        protected final RiakPB.RpbBucketProps.Builder propsBuilder</span>
<span class="nc" id="L73">                = RiakPB.RpbBucketProps.newBuilder();</span>

        protected abstract T self();

        /**
         * Set the allow_multi value.
         *
         * @param allow whether to allow sibling objects to be created.
         * @return a reference to this object.
         */
        public T withAllowMulti(boolean allow)
        {
<span class="nc" id="L85">            propsBuilder.setAllowMult(allow);</span>
<span class="nc" id="L86">            return self();</span>
        }

        /**
         * Set the backend used by this bucket. Only applies when using
         * {@code riak_kv_multi_backend} in Riak.
         *
         * @param backend the name of the backend to use.
         * @return a reference to this object.
         */
        public T withBackend(String backend)
        {
<span class="nc bnc" id="L98" title="All 4 branches missed.">            if (null == backend || backend.length() == 0)</span>
            {
<span class="nc" id="L100">                throw new IllegalArgumentException(&quot;Backend can not be null or zero length&quot;);</span>
            }
<span class="nc" id="L102">            propsBuilder.setBackend(ByteString.copyFromUtf8(backend));</span>
<span class="nc" id="L103">            return self();</span>
        }

        /**
         * Set the basic_quorum value.
         *
         * The parameter controls whether a read request should return early in
         * some fail cases. E.g. If a quorum of nodes has already returned
         * notfound/error, don't wait around for the rest.
         *
         * @param use the basic_quorum value.
         * @return a reference to this object.
         */
        public T withBasicQuorum(boolean use)
        {
<span class="nc" id="L118">            propsBuilder.setBasicQuorum(use);</span>
<span class="nc" id="L119">            return self();</span>
        }

        /**
         * Set the big_vclock value.
         *
         * @param bigVClock a long representing a epoch time value.
         * @return a reference to this object.
         * @see &lt;a href=&quot;http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/#Vector-Clock-Pruning&quot;&gt;Vector Clock Pruning&lt;/a&gt;
         */
        public T withBigVClock(Long bigVClock)
        {
<span class="nc" id="L131">            propsBuilder.setBigVclock(bigVClock.intValue());</span>
<span class="nc" id="L132">            return self();</span>
        }

        /**
         * Set the chash_keyfun value.
         *
         * @param func a Function representing the Erlang func to use.
         * @return a reference to this object.
         */
        public T withChashkeyFunction(Function func)
        {
<span class="nc" id="L143">            verifyErlangFunc(func);</span>
<span class="nc" id="L144">            propsBuilder.setChashKeyfun(convertModFun(func));</span>
<span class="nc" id="L145">            return self();</span>
        }

        /**
         * Set the last_write_wins value. Unless you really know what you're
         * doing, you probably do not want to set this to true.
         *
         * @param wins whether to ignore vector clocks when writing.
         * @return a reference to this object.
         */
        public T withLastWriteWins(boolean wins)
        {
<span class="nc" id="L157">            propsBuilder.setLastWriteWins(wins);</span>
<span class="nc" id="L158">            return self();</span>
        }

        /**
         * Set the linkfun value.
         *
         * @param func a Function representing the Erlang func to use.
         * @return a reference to this object.
         */
        public T withLinkwalkFunction(Function func)
        {
<span class="nc" id="L169">            verifyErlangFunc(func);</span>
<span class="nc" id="L170">            propsBuilder.setLinkfun(convertModFun(func));</span>
<span class="nc" id="L171">            return self();</span>
        }

        /**
         * Set the rw value. Individual requests (or buckets in a bucket type)
         * can override this.
         *
         * @param rw the rw value as an integer.
         * @return a reference to this object.
         */
        public T withRw(int rw)
        {
<span class="nc" id="L183">            propsBuilder.setRw(rw);</span>
<span class="nc" id="L184">            return self();</span>
        }

        /**
         * Set the dw value. Individual requests (or buckets in a bucket type)
         * can override this.
         *
         * @param dw the dw value as an integer.
         * @return a reference to this object.
         */
        public T withDw(int dw)
        {
<span class="nc" id="L196">            propsBuilder.setDw(dw);</span>
<span class="nc" id="L197">            return self();</span>
        }

        /**
         * Set the w value. Individual requests (or buckets in a bucket type)
         * can override this.
         *
         * @param w the w value as an integer.
         * @return a reference to this object.
         */
        public T withW(int w)
        {
<span class="nc" id="L209">            propsBuilder.setW(w);</span>
<span class="nc" id="L210">            return self();</span>
        }

        /**
         * Set the r value. Individual requests (or buckets in a bucket type)
         * can override this.
         *
         * @param r the r value as an integer.
         * @return a reference to this object.
         */
        public T withR(int r)
        {
<span class="nc" id="L222">            propsBuilder.setR(r);</span>
<span class="nc" id="L223">            return self();</span>
        }

        /**
         * Set the pr value. Individual requests (or buckets in a bucket type)
         * can override this.
         *
         * @param pr the pr value as an integer.
         * @return a reference to this object.
         */
        public T withPr(int pr)
        {
<span class="nc" id="L235">            propsBuilder.setPr(pr);</span>
<span class="nc" id="L236">            return self();</span>
        }

        /**
         * Set the pw value. Individual requests (or buckets in a bucket type)
         * can override this.
         *
         * @param pw the pw value as an integer.
         * @return a reference to this object.
         */
        public T withPw(int pw)
        {
<span class="nc" id="L248">            propsBuilder.setPw(pw);</span>
<span class="nc" id="L249">            return self();</span>
        }

        /**
         * Set the not_found_ok value. If true a vnode returning notfound for a
         * key increments the r tally. False is higher consistency, true is
         * higher availability.
         *
         * @param ok the not_found_ok value.
         * @return a reference to this object.
         */
        public T withNotFoundOk(boolean ok)
        {
<span class="nc" id="L262">            propsBuilder.setNotfoundOk(ok);</span>
<span class="nc" id="L263">            return self();</span>
        }

        /**
         * Add a pre-commit hook. The supplied Function must be an Erlang or
         * Named JS function.
         *
         * @param hook the Function to add.
         * @return a reference to this object.
         * @see &lt;a
         * href=&quot;http://docs.basho.com/riak/latest/dev/using/commit-hooks/&quot;&gt;Using
         * Commit Hooks&lt;/a&gt;
         */
        public T withPrecommitHook(Function hook)
        {
<span class="nc bnc" id="L278" title="All 6 branches missed.">            if (null == hook || !(!hook.isJavascript() || hook.isNamed()))</span>
            {
<span class="nc" id="L280">                throw new IllegalArgumentException(&quot;Must be a named JS or Erlang function.&quot;);</span>
            }

<span class="nc" id="L283">            propsBuilder.addPrecommit(convertHook(hook));</span>
<span class="nc" id="L284">            return self();</span>
        }

        /**
         * Add a post-commit hook. The supplied Function must be an Erlang or
         * Named JS function.
         *
         * @param hook the Function to add.
         * @return a reference to this object.
         * @see &lt;a
         * href=&quot;http://docs.basho.com/riak/latest/dev/using/commit-hooks/&quot;&gt;Using
         * Commit Hooks&lt;/a&gt;
         */
        public T withPostcommitHook(Function hook)
        {
<span class="nc" id="L299">            verifyErlangFunc(hook);</span>
<span class="nc" id="L300">            propsBuilder.addPostcommit(convertHook(hook));</span>
<span class="nc" id="L301">            return self();</span>
        }

        /**
         * Set the old_vclock value.
         *
         * @param oldVClock an long representing a epoch time value.
         * @return a reference to this object.
         * @see &lt;a
         * href=&quot;http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/#Vector-Clock-Pruning&quot;&gt;Vector
         * Clock Pruning&lt;/a&gt;
         */
        public T withOldVClock(Long oldVClock)
        {
<span class="nc" id="L315">            propsBuilder.setOldVclock(oldVClock.intValue());</span>
<span class="nc" id="L316">            return self();</span>
        }

        /**
         * Set the young_vclock value.
         *
         * @param youngVClock a long representing a epoch time value.
         * @return a reference to this object.
         * @see &lt;a
         * href=&quot;http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/#Vector-Clock-Pruning&quot;&gt;Vector
         * Clock Pruning&lt;/a&gt;
         */
        public T withYoungVClock(Long youngVClock)
        {
<span class="nc" id="L330">            propsBuilder.setYoungVclock(youngVClock.intValue());</span>
<span class="nc" id="L331">            return self();</span>
        }

        /**
         * Set the small_vclock value.
         *
         * @param smallVClock a long representing a epoch time value.
         * @return a reference to this object.
         * @see &lt;a
         * href=&quot;http://docs.basho.com/riak/latest/theory/concepts/Vector-Clocks/#Vector-Clock-Pruning&quot;&gt;Vector
         * Clock Pruning&lt;/a&gt;
         */
        public T withSmallVClock(Long smallVClock)
        {
<span class="nc" id="L345">            propsBuilder.setSmallVclock(smallVClock.intValue());</span>
<span class="nc" id="L346">            return self();</span>
        }

        /**
         * Set the nVal.
         *
         * @param nVal the number of replicas.
         * @return a reference to this object.
         */
        public T withNVal(int nVal)
        {
<span class="nc bnc" id="L357" title="All 2 branches missed.">            if (nVal &lt;= 0)</span>
            {
<span class="nc" id="L359">                throw new IllegalArgumentException(&quot;nVal must be &gt;= 1&quot;);</span>
            }
<span class="nc" id="L361">            propsBuilder.setNVal(nVal);</span>
<span class="nc" id="L362">            return self();</span>
        }

        /**
         * Enable Legacy Riak Search. Setting this to true causes the search
         * pre-commit hook to be added.
         *
         * &lt;b&gt;Note this is only for legacy Riak (&amp;lt; v2.0) Search support.&lt;/b&gt;
         *
         * @param enable add/remove (true/false) the pre-commit hook for Legacy
         * Riak Search.
         * @return a reference to this object.
         */
        public T withLegacyRiakSearchEnabled(boolean enable)
        {
<span class="nc" id="L377">            propsBuilder.setSearch(enable);</span>
<span class="nc" id="L378">            return self();</span>
        }

        /**
         * Associate a Search Index. This only applies if Yokozuna is enabled in
         * Riak v2.0.
         *
         * @param indexName The name of the search index to use.
         * @return a reference to this object.
         */
        public T withSearchIndex(String indexName)
        {
<span class="nc bnc" id="L390" title="All 4 branches missed.">            if (null == indexName || indexName.length() == 0)</span>
            {
<span class="nc" id="L392">                throw new IllegalArgumentException(&quot;Index name cannot be null or zero length&quot;);</span>
            }
<span class="nc" id="L394">            propsBuilder.setSearchIndex(ByteString.copyFromUtf8(indexName));</span>
<span class="nc" id="L395">            return self();</span>
        }

        /**
         * Set the HyperLogLog Precision.
         *
         * @param precision the number of bits to use in the HyperLogLog precision.
         *                  Valid values are [4 - 16] inclusive, default is 14 on new buckets.
         *                  &lt;b&gt;NOTE:&lt;/b&gt; When changing precision, it may only be reduced from
         *                  it's current value, and never increased.
         * @return a reference to this object.
         */
        public T withHllPrecision(int precision)
        {
<span class="nc bnc" id="L409" title="All 4 branches missed.">            if (precision &lt; 4 || precision &gt; 16)</span>
            {
<span class="nc" id="L411">                throw new IllegalArgumentException(&quot;Precision must be between 4 and 16, inclusive.&quot;);</span>
            }
<span class="nc" id="L413">            propsBuilder.setHllPrecision(precision);</span>
<span class="nc" id="L414">            return self();</span>
        }

        private void verifyErlangFunc(Function f)
        {
<span class="nc bnc" id="L419" title="All 4 branches missed.">            if (null == f || f.isJavascript())</span>
            {
<span class="nc" id="L421">                throw new IllegalArgumentException(&quot;Must be an Erlang Function.&quot;);</span>
            }
<span class="nc" id="L423">        }</span>

        private RiakPB.RpbModFun convertModFun(Function f)
        {
<span class="nc" id="L427">            return RiakPB.RpbModFun.newBuilder()</span>
<span class="nc" id="L428">                    .setModule(ByteString.copyFromUtf8(f.getModule()))</span>
<span class="nc" id="L429">                    .setFunction(ByteString.copyFromUtf8(f.getFunction()))</span>
<span class="nc" id="L430">                    .build();</span>
        }

        private RiakPB.RpbCommitHook convertHook(Function hook)
        {
<span class="nc" id="L435">            RiakPB.RpbCommitHook.Builder builder = RiakPB.RpbCommitHook.newBuilder();</span>
<span class="nc" id="L436">            RiakPB.RpbModFun.Builder mfBuilder = RiakPB.RpbModFun.newBuilder();</span>

<span class="nc bnc" id="L438" title="All 2 branches missed.">            if (hook.isJavascript())</span>
            {
<span class="nc" id="L440">                builder.setName(ByteString.copyFromUtf8(hook.getName()));</span>
            }
            else
            {
<span class="nc" id="L444">                mfBuilder.setModule(ByteString.copyFromUtf8(hook.getModule()));</span>
<span class="nc" id="L445">                mfBuilder.setFunction(ByteString.copyFromUtf8(hook.getFunction()));</span>
<span class="nc" id="L446">                builder.setModfun(mfBuilder);</span>
            }

<span class="nc" id="L449">            return builder.build();</span>
        }
    }

    public static class Builder extends PropsBuilder&lt;Builder&gt;
    {
<span class="nc" id="L455">        private final RiakPB.RpbSetBucketReq.Builder reqBuilder</span>
<span class="nc" id="L456">            = RiakPB.RpbSetBucketReq.newBuilder();</span>
        private final Namespace namespace;

        /**
         * Constructs a builder for a StoreBucketPropsOperation.
         * @param namespace The namespace in Riak.
         */
        public Builder(Namespace namespace)
<span class="nc" id="L464">        {</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">            if (namespace == null)</span>
            {
<span class="nc" id="L467">                throw new IllegalArgumentException(&quot;Namespace cannot be null&quot;);</span>
            }
<span class="nc" id="L469">            reqBuilder.setBucket(ByteString.copyFrom(namespace.getBucketName().unsafeGetValue()));</span>
<span class="nc" id="L470">            reqBuilder.setType(ByteString.copyFrom(namespace.getBucketType().unsafeGetValue()));</span>
<span class="nc" id="L471">            this.namespace = namespace;</span>
<span class="nc" id="L472">        }</span>

        @Override
        protected Builder self()
        {
<span class="nc" id="L477">            return this;</span>
        }

        public StoreBucketPropsOperation build()
        {
<span class="nc" id="L482">            reqBuilder.setProps(propsBuilder);</span>
<span class="nc" id="L483">            return new StoreBucketPropsOperation(this);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>