<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Cell.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Riak Client for Java</a> &gt; <a href="index.source.html" class="el_package">com.basho.riak.client.core.query.timeseries</a> &gt; <span class="el_source">Cell.java</span></div><h1>Cell.java</h1><pre class="source lang-java linenums">package com.basho.riak.client.core.query.timeseries;

import com.basho.riak.client.core.util.BinaryValue;
import com.basho.riak.client.core.util.CharsetUtils;
import com.basho.riak.protobuf.RiakTsPB;
import com.google.protobuf.ByteString;

import javax.xml.bind.DatatypeConverter;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;

/**
 * Holds a piece of data for a Time Series @{link Row}.
 * A cell can hold 6 different types of raw data:
 * &lt;ol&gt;
 * &lt;li&gt;&lt;b&gt;Varchar&lt;/b&gt;s, which can hold byte arrays. Commonly used to store encoded strings.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;SInt64&lt;/b&gt;s, which can hold any signed 64-bit integers.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;Double&lt;/b&gt;s, which can hold any 64-bit floating point numbers.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;Timestamp&lt;/b&gt;s, which can hold any unix/epoch timestamp. Millisecond resolution is required.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;Boolean&lt;/b&gt;s, which can hold a true/false value. &lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;Blob&lt;/b&gt;s, which can hold any binary data.&lt;/li&gt;
 * &lt;/ol&gt;
 * Immutable once created.
 *
 * @author Alex Moore &lt;amoore at basho dot com&gt;
 * @author Sergey Galkin &lt;srggal at gmail dot com&gt;
 * @since 2.0.3
 */

public class Cell
{
    private static final int VARCHAR_MASK = 0x00000001;
    private static final int SINT64_MASK = 0x00000002;
    private static final int DOUBLE_MASK = 0x00000004;
    private static final int TIMESTAMP_MASK = 0x00000008;
    private static final int BOOLEAN_MASK = 0x00000010;
    private static final int BLOB_MASK = 0x00000011;
<span class="fc" id="L39">    private int typeBitfield = 0x0;</span>

<span class="fc" id="L41">    private String varcharValue = &quot;&quot;;</span>
<span class="fc" id="L42">    private long sint64Value = 0L;</span>
<span class="fc" id="L43">    private double doubleValue = 0.0;</span>
<span class="fc" id="L44">    private long timestampValue = 0L;</span>
<span class="fc" id="L45">    private boolean booleanValue = false;</span>
<span class="fc" id="L46">    private byte[] blobValue = {};</span>

    /**
     * Creates a new &quot;Varchar&quot; Cell, based on the UTF8 binary encoding of the provided String.
     *
     * @param varcharValue The string to encode and store.
     */
    public Cell(String varcharValue)
<span class="fc" id="L54">    {</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (varcharValue == null)</span>
        {
<span class="nc" id="L57">            throw new IllegalArgumentException(&quot;String value cannot be NULL.&quot;);</span>
        }

<span class="fc" id="L60">        initVarchar(varcharValue);</span>
<span class="fc" id="L61">    }</span>

    /**
     * Creates a new &quot;Varchar&quot; cell from the provided BinaryValue.
     *
     * @param varcharValue The BinaryValue to store.
     */
    public Cell(BinaryValue varcharValue)
<span class="fc" id="L69">    {</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (varcharValue == null)</span>
        {
<span class="nc" id="L72">            throw new IllegalArgumentException(&quot;BinaryValue value cannot be NULL.&quot;);</span>
        }

<span class="fc" id="L75">        initVarchar(varcharValue.toStringUtf8());</span>
<span class="fc" id="L76">    }</span>

    /**
     * Creates a new &quot;Integer&quot; Cell from the provided long.
     *
     * @param sint64Value The long to store.
     */
    public Cell(long sint64Value)
<span class="fc" id="L84">    {</span>
<span class="fc" id="L85">        initSInt64(sint64Value);</span>
<span class="fc" id="L86">    }</span>

    /**
     * Creates a new double cell.
     *
     * @param doubleValue The double to store.
     */
    public Cell(double doubleValue)
<span class="fc" id="L94">    {</span>
<span class="fc" id="L95">        initDouble(doubleValue);</span>
<span class="fc" id="L96">    }</span>

    /**
     * Creates a new &quot;Boolean&quot; Cell from the provided boolean.
     *
     * @param booleanValue The boolean to store.
     */
    public Cell(boolean booleanValue)
<span class="fc" id="L104">    {</span>
<span class="fc" id="L105">        initBoolean(booleanValue);</span>
<span class="fc" id="L106">    }</span>

    /**
     * Creates a new &quot;Timestamp&quot; Cell from the provided Calendar, by fetching the current time in milliseconds.
     *
     * @param timestampValue The Calendar to fetch the timestamp from.
     */
    public Cell(Calendar timestampValue)
<span class="fc" id="L114">    {</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        if (timestampValue == null)</span>
        {
<span class="nc" id="L117">            throw new IllegalArgumentException(&quot;Calendar object for timestamp value cannot be NULL.&quot;);</span>
        }

<span class="fc" id="L120">        initTimestamp(timestampValue.getTimeInMillis());</span>
<span class="fc" id="L121">    }</span>

    /**
     * Creates a new &quot;Timestamp&quot; Cell from the provided Date, by fetching the current time in milliseconds.
     *
     * @param timestampValue The Date to fetch the timestamp from.
     */
    public Cell(Date timestampValue)
<span class="fc" id="L129">    {</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if (timestampValue == null)</span>
        {
<span class="nc" id="L132">            throw new IllegalArgumentException(&quot;Date object for timestamp value cannot be NULL.&quot;);</span>
        }

<span class="fc" id="L135">        initTimestamp(timestampValue.getTime());</span>
<span class="fc" id="L136">    }</span>

    /**
     * Creates a new &quot;Blob&quot; Cell from the provided byte array.
     *
     * @param blobValue The blob to store.
     */
    public Cell(byte[] blobValue)
<span class="fc" id="L144">    {</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (blobValue == null)</span>
        {
<span class="nc" id="L147">            throw new IllegalArgumentException(&quot;Value for BLOB value cannot be NULL.&quot;);</span>
        }

<span class="fc" id="L150">        initBlob(blobValue);</span>
<span class="fc" id="L151">    }</span>

    Cell(RiakTsPB.TsCell pbCell, RiakTsPB.TsColumnDescription columnDescription)
<span class="fc" id="L154">    {</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if (pbCell.hasBooleanValue())</span>
        {
<span class="fc" id="L157">            initBoolean(pbCell.getBooleanValue());</span>
        }
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        else if (pbCell.hasDoubleValue())</span>
        {
<span class="nc" id="L161">            initDouble(pbCell.getDoubleValue());</span>
        }
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        else if (pbCell.hasSint64Value())</span>
        {
<span class="nc" id="L165">            initSInt64(pbCell.getSint64Value());</span>
        }
<span class="fc bfc" id="L167" title="All 2 branches covered.">        else if (pbCell.hasTimestampValue())</span>
        {
<span class="fc" id="L169">            initTimestamp(pbCell.getTimestampValue());</span>
        }
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        else if (pbCell.hasVarcharValue() )</span>
        {
            //  If there is no column description provided, VARCHAR will be used by default
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">            final RiakTsPB.TsColumnType type = columnDescription == null ? RiakTsPB.TsColumnType.VARCHAR : columnDescription.getType();</span>

<span class="pc bpc" id="L176" title="1 of 3 branches missed.">            switch (type)</span>
            {
                case VARCHAR:
<span class="fc" id="L179">                    initVarchar(pbCell.getVarcharValue().toStringUtf8());</span>
<span class="fc" id="L180">                    break;</span>

                case BLOB:
<span class="fc" id="L183">                    initBlob(pbCell.getVarcharValue().toByteArray());</span>
<span class="fc" id="L184">                    break;</span>

                default:
<span class="nc" id="L187">                    throw new IllegalStateException(</span>
<span class="nc" id="L188">                            String.format(</span>
                                    &quot;Type '%s' from the provided ColumnDefinition contradicts to the actual VARCHAR value&quot;,
<span class="nc" id="L190">                                    type.name()</span>
                                )
                        );
            }
<span class="fc" id="L194">        }</span>
        else
        {
<span class="nc" id="L197">            throw new IllegalArgumentException(&quot;Unknown PB Cell encountered.&quot;);</span>
        }
<span class="fc" id="L199">    }</span>

    private Cell()
<span class="fc" id="L202">    {</span>
<span class="fc" id="L203">    }</span>

    /**
     * Creates a new &quot;Timestamp&quot; cell from the provided raw value.
     *
     * @param rawTimestampValue The epoch timestamp, including milliseconds.
     * @return The new timestamp Cell.
     */
    public static Cell newTimestamp(long rawTimestampValue)
    {
<span class="fc" id="L213">        final Cell cell = new Cell();</span>
<span class="fc" id="L214">        cell.initTimestamp(rawTimestampValue);</span>
<span class="fc" id="L215">        return cell;</span>
    }

    private void initBoolean(boolean booleanValue)
    {
<span class="fc" id="L220">        setBitfieldType(BOOLEAN_MASK);</span>
<span class="fc" id="L221">        this.booleanValue = booleanValue;</span>
<span class="fc" id="L222">    }</span>

    private void initTimestamp(long timestampValue)
    {
<span class="fc" id="L226">        setBitfieldType(TIMESTAMP_MASK);</span>
<span class="fc" id="L227">        this.timestampValue = timestampValue;</span>
<span class="fc" id="L228">    }</span>

    private void initDouble(double doubleValue)
    {
<span class="fc" id="L232">        setBitfieldType(DOUBLE_MASK);</span>
<span class="fc" id="L233">        this.doubleValue = doubleValue;</span>
<span class="fc" id="L234">    }</span>

    private void initSInt64(long longValue)
    {
<span class="fc" id="L238">        setBitfieldType(SINT64_MASK);</span>
<span class="fc" id="L239">        this.sint64Value = longValue;</span>
<span class="fc" id="L240">    }</span>

    private void initVarchar(String stringValue)
    {
<span class="fc" id="L244">        setBitfieldType(VARCHAR_MASK);</span>
<span class="fc" id="L245">        this.varcharValue = stringValue;</span>
<span class="fc" id="L246">    }</span>

    private void initBlob(byte[] blobValue)
    {
<span class="fc" id="L250">        setBitfieldType(BLOB_MASK);</span>
<span class="fc" id="L251">        this.blobValue = blobValue;</span>
<span class="fc" id="L252">    }</span>

    private void setBitfieldType(int mask)
    {
<span class="fc" id="L256">        typeBitfield |= mask;</span>
<span class="fc" id="L257">    }</span>

    private boolean bitfieldHasType(int mask)
    {
<span class="fc bfc" id="L261" title="All 2 branches covered.">        return typeBitfield == mask;</span>
    }

    public boolean hasVarcharValue()
    {
<span class="fc" id="L266">        return bitfieldHasType(VARCHAR_MASK);</span>
    }

    public boolean hasLong()
    {
<span class="fc" id="L271">        return bitfieldHasType(SINT64_MASK);</span>
    }

    public boolean hasDouble()
    {
<span class="fc" id="L276">        return bitfieldHasType(DOUBLE_MASK);</span>
    }

    public boolean hasTimestamp()
    {
<span class="fc" id="L281">        return bitfieldHasType(TIMESTAMP_MASK);</span>
    }

    public boolean hasBoolean()
    {
<span class="fc" id="L286">        return bitfieldHasType(BOOLEAN_MASK);</span>
    }

    public boolean hasBlob()
    {
<span class="fc" id="L291">        return bitfieldHasType(BLOB_MASK);</span>
    }

    public String getVarcharAsUTF8String()
    {
<span class="fc" id="L296">        return varcharValue;</span>
    }

    public BinaryValue getVarcharValue()
    {
<span class="fc" id="L301">        return BinaryValue.unsafeCreate(varcharValue.getBytes(CharsetUtils.UTF_8));</span>
    }

    public long getLong()
    {
<span class="fc" id="L306">        return sint64Value;</span>
    }

    public double getDouble()
    {
<span class="fc" id="L311">        return doubleValue;</span>
    }

    public long getTimestamp()
    {
<span class="fc" id="L316">        return timestampValue;</span>
    }

    public boolean getBoolean()
    {
<span class="fc" id="L321">        return booleanValue;</span>
    }

    public byte[] getBlob()
    {
<span class="fc" id="L326">        return blobValue;</span>
    }

    RiakTsPB.TsCell getPbCell()
    {
<span class="fc" id="L331">        final RiakTsPB.TsCell.Builder builder = RiakTsPB.TsCell.newBuilder();</span>

<span class="fc bfc" id="L333" title="All 2 branches covered.">        if (hasVarcharValue())</span>
        {
<span class="fc" id="L335">            builder.setVarcharValue(ByteString.copyFromUtf8(varcharValue));</span>
        }
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">        else if (hasLong())</span>
        {
<span class="nc" id="L339">            builder.setSint64Value(sint64Value);</span>
        }
<span class="fc bfc" id="L341" title="All 2 branches covered.">        else if (hasTimestamp())</span>
        {
<span class="fc" id="L343">            builder.setTimestampValue(timestampValue);</span>
        }
<span class="fc bfc" id="L345" title="All 2 branches covered.">        else if (hasBoolean())</span>
        {
<span class="fc" id="L347">            builder.setBooleanValue(booleanValue);</span>
        }
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">        else if (hasDouble())</span>
        {
<span class="nc" id="L351">            builder.setDoubleValue(doubleValue);</span>
        }
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">        else if(hasBlob())</span>
        {
<span class="fc" id="L355">            builder.setVarcharValue(ByteString.copyFrom(blobValue));</span>
        }

<span class="fc" id="L358">        return builder.build();</span>
    }

    @Override
    public String toString()
    {
<span class="fc" id="L364">        final StringBuilder sb = new StringBuilder(&quot;Cell{ &quot;);</span>

<span class="fc bfc" id="L366" title="All 2 branches covered.">        if (this.hasVarcharValue())</span>
        {
<span class="fc" id="L368">            final String value = this.getVarcharAsUTF8String();</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">            if (value.length() &gt; 32)</span>
            {
<span class="nc" id="L371">                sb.append(value.substring(0, 32));</span>
<span class="nc" id="L372">                sb.append(&quot;...&quot;);</span>
            }
            else
            {
<span class="fc" id="L376">                sb.append(value);</span>
            }
<span class="fc" id="L378">        }</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">        else if (this.hasLong())</span>
        {
<span class="nc" id="L381">            sb.append(this.getLong());</span>
        }
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">        else if (this.hasDouble())</span>
        {
<span class="nc" id="L385">            sb.append(this.getDouble());</span>
        }
<span class="fc bfc" id="L387" title="All 2 branches covered.">        else if (this.hasTimestamp())</span>
        {
<span class="fc" id="L389">            sb.append(this.getTimestamp());</span>
        }
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">        else if (this.hasBoolean())</span>
        {
<span class="nc" id="L393">            sb.append(this.getBoolean());</span>
        }
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">        else if (this.hasBlob())</span>
        {
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">            final int length = blobValue.length &gt; 8 ? 8 : blobValue.length;</span>
<span class="fc" id="L398">            final byte[] blobBlurb = Arrays.copyOfRange(blobValue, 0, length);</span>
<span class="fc" id="L399">            sb.append(&quot;0x&quot;);</span>
<span class="fc" id="L400">            sb.append(DatatypeConverter.printHexBinary(blobBlurb));</span>
        }

<span class="fc" id="L403">        sb.append(&quot; }&quot;);</span>
<span class="fc" id="L404">        return sb.toString();</span>
    }

    @Override
    public boolean equals(Object o)
    {
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">        if (this == o)</span>
        {
<span class="nc" id="L412">            return true;</span>
        }
<span class="pc bpc" id="L414" title="2 of 4 branches missed.">        if (o == null || getClass() != o.getClass())</span>
        {
<span class="nc" id="L416">            return false;</span>
        }

<span class="fc" id="L419">        Cell cell = (Cell) o;</span>

<span class="pc bpc" id="L421" title="1 of 2 branches missed.">        if (typeBitfield != cell.typeBitfield)</span>
        {
<span class="nc" id="L423">            return false;</span>
        }
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">        if (sint64Value != cell.sint64Value)</span>
        {
<span class="nc" id="L427">            return false;</span>
        }
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">        if (Double.compare(cell.doubleValue, doubleValue) != 0)</span>
        {
<span class="nc" id="L431">            return false;</span>
        }
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (timestampValue != cell.timestampValue)</span>
        {
<span class="nc" id="L435">            return false;</span>
        }
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (booleanValue != cell.booleanValue)</span>
        {
<span class="nc" id="L439">            return false;</span>
        }
<span class="pc bpc" id="L441" title="4 of 6 branches missed.">        if (varcharValue != null ? !varcharValue.equals(cell.varcharValue) : cell.varcharValue != null)</span>
        {
<span class="nc" id="L443">            return false;</span>
        }
<span class="fc" id="L445">        return Arrays.equals(blobValue, cell.blobValue);</span>

    }

    @Override
    public int hashCode()
    {
        int result;
        long temp;
<span class="nc" id="L454">        result = typeBitfield;</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        result = 31 * result + (varcharValue != null ? varcharValue.hashCode() : 0);</span>
<span class="nc" id="L456">        result = 31 * result + (int) (sint64Value ^ (sint64Value &gt;&gt;&gt; 32));</span>
<span class="nc" id="L457">        temp = Double.doubleToLongBits(doubleValue);</span>
<span class="nc" id="L458">        result = 31 * result + (int) (temp ^ (temp &gt;&gt;&gt; 32));</span>
<span class="nc" id="L459">        result = 31 * result + (int) (timestampValue ^ (timestampValue &gt;&gt;&gt; 32));</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">        result = 31 * result + (booleanValue ? 1 : 0);</span>
<span class="nc" id="L461">        result = 31 * result + Arrays.hashCode(blobValue);</span>
<span class="nc" id="L462">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>