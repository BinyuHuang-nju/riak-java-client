<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultCharset.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Riak Client for Java</a> &gt; <a href="index.source.html" class="el_package">com.basho.riak.client.core.util</a> &gt; <span class="el_source">DefaultCharset.java</span></div><h1>DefaultCharset.java</h1><pre class="source lang-java linenums">package com.basho.riak.client.core.util;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.nio.charset.Charset;
import java.util.concurrent.atomic.AtomicReference;

/**
 * &lt;p&gt;
 * Holds an classloader-wide default charset, that
 * is then used to encode/decode between Strings and
 * Byte arrays for Riak's use (see {@link com.basho.riak.client.core.util.BinaryValue}).
 * &lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;
 * Before 2.0.3, the system used the JRE's default Charset from the
 * {@link Charset#defaultCharset()} property.
 * &lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;
 * With this class you may change the Riak client to use a different default.
 * You can set it at startup by providing the desired Charset name with the vm argument
 * {@code -Dcom.basho.riak.client.DefaultCharset=&quot;UTF-8&quot;}, or at runtime
 * with the static method (see {@link #set(Charset)}).
 * &lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;
 * As of 2.0.3 it still defaults to the value provided by
 * {@link Charset#defaultCharset()},
 * but the default is planned to change to &quot;UTF-8&quot; with 2.1.0.
 * &lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;
 * If your JRE default charset is one of &quot;&lt;b&gt;US-ASCII&lt;/b&gt;&quot;,
 * &quot;&lt;b&gt;UTF-8&lt;/b&gt;&quot;, or &quot;&lt;b&gt;ISO-8859-1&lt;/b&gt;&quot;,
 * this change should &lt;b&gt;not&lt;/b&gt; affect you.
 * &lt;/p&gt;
 * &lt;p/&gt;
 * &lt;p&gt;
 * If your JRE default charset is one of &quot;&lt;b&gt;UTF-16&lt;/b&gt;&quot;,
 * &quot;&lt;b&gt;UTF-16BE&lt;/b&gt;&quot;, or &quot;&lt;b&gt;UTF-16LE&lt;/b&gt;&quot;,
 * &lt;b&gt;you will need to set that default on the command line or
 * after application startup once you upgrade&lt;/b&gt;.
 * &lt;/p&gt;
 *
 * @author Alex Moore &lt;amoore AT basho dot com&gt;
 * @since 2.0.3
 */

public final class DefaultCharset
{
<span class="fc" id="L53">    private static final Logger logger = LoggerFactory.getLogger(DefaultCharset.class);</span>
<span class="fc" id="L54">    private final static DefaultCharset instance = initializeDefaultCharsetSingleton();</span>

    private final AtomicReference&lt;Charset&gt; currentCharset;

    private DefaultCharset(Charset c)
<span class="fc" id="L59">    {</span>
<span class="fc" id="L60">        logger.info(&quot;Initializing client charset to: {}&quot;, c.name());</span>
<span class="fc" id="L61">        this.currentCharset = new AtomicReference&lt;&gt;(c);</span>
<span class="fc" id="L62">    }</span>

    private static DefaultCharset initializeDefaultCharsetSingleton()
    {
        Charset charset;
<span class="fc" id="L67">        final Charset systemDefault = Charset.defaultCharset();</span>
<span class="fc" id="L68">        final String declaredCharsetName = System.getProperty(Constants.CLIENT_OPTION_CHARSET);</span>

<span class="pc bpc" id="L70" title="1 of 4 branches missed.">        if (declaredCharsetName != null &amp;&amp; !declaredCharsetName.isEmpty())</span>
        {
            try
            {
<span class="fc" id="L74">                charset = Charset.forName(declaredCharsetName);</span>
            }
<span class="fc" id="L76">            catch (Exception ex)</span>
            {
<span class="fc" id="L78">                charset = systemDefault;</span>
<span class="fc" id="L79">                logger.warn(&quot;Requested charset '{}' is not available, the default charset '{}' will be used&quot;,</span>
                            declaredCharsetName,
<span class="fc" id="L81">                            charset.name());</span>
<span class="fc" id="L82">            }</span>
        }
        else
        {
<span class="fc" id="L86">            logger.info(&quot;No desired charset found in system properties, the default charset '{}' will be used&quot;,</span>
<span class="fc" id="L87">                        systemDefault.name());</span>
<span class="fc" id="L88">            charset = systemDefault;</span>
        }

<span class="fc" id="L91">        return new DefaultCharset(charset);</span>
    }

    /**
     * Get the current classloader-wide default Charset for the Riak client.
     *
     * @return The current classloader-wide default charset.
     */
    public static Charset get()
    {
<span class="fc" id="L101">        return instance.currentCharset.get();</span>
    }

    /**
     * Set the classloader-wide default Charset for the Riak client.
     *
     * @param charset The charset to set the classloader-wide default to.
     */
    public static void set(Charset charset)
    {
<span class="fc" id="L111">        final Charset current = instance.currentCharset.get();</span>
<span class="fc" id="L112">        logger.info(&quot;Setting client charset from '{}' to '{}'&quot;, current.name(), charset.name());</span>
<span class="fc" id="L113">        instance.currentCharset.set(charset);</span>
<span class="fc" id="L114">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>