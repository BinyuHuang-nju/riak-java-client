<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RiakObject.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Riak Client for Java</a> &gt; <a href="index.source.html" class="el_package">com.basho.riak.client.core.query</a> &gt; <span class="el_source">RiakObject.java</span></div><h1>RiakObject.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013 Basho Technologies Inc
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.basho.riak.client.core.query;

import com.basho.riak.client.api.annotations.RiakVClock;
import com.basho.riak.client.api.cap.VClock;
import com.basho.riak.client.core.query.UserMetadata.RiakUserMetadata;
import com.basho.riak.client.core.query.indexes.RiakIndexes;
import com.basho.riak.client.core.query.links.RiakLinks;
import com.basho.riak.client.core.util.BinaryValue;
import com.basho.riak.client.core.util.CharsetUtils;

import java.nio.charset.Charset;

/**
 * Represents the data and metadata stored in Riak
 * &lt;p&gt;
 * While the client APIs provide methods to store/retrieve data to/from Riak using your own
 * Beans/POJOs, this class is used as the core data type to and from which those types are
 * converted.
 * &lt;/p&gt;
 * &lt;p&gt;
 * &lt;h5&gt;Working with Metadata&lt;/h5&gt;
 * An object in Riak has a few types of metadata that can be attached; Secondary
 * Indexes, Links, and User Metadata. Each of these has its own container in
 * {@code RiakObject} and methods are provided to access them.
 * &lt;/p&gt;
 * &lt;p&gt;
 * &lt;br/&gt;&lt;b&gt;Thread Safety:&lt;/b&gt;&lt;br/&gt;
 * RiakObject is designed to be thread safe. All methods
 * which update the object do so via a thread safe mechanism. The only caveat is
 * that if you use any of the methods prefixed with &quot;unsafe&quot; you need to
 * understand the ramifications as noted in their Javadoc.
 * &lt;/p&gt;
 *
 * @author Brian Roach &lt;roach at basho dot com&gt;
 * @since 2.0
 */
public final class RiakObject
{
    /**
     * The default content type assigned when storing in Riak if one is not
     * provided. {@value #DEFAULT_CONTENT_TYPE}
     *
     * @see RiakObject#setContentType(java.lang.String)
     */
    public final static String DEFAULT_CONTENT_TYPE = &quot;application/octet-stream&quot;;

    // Mutable types.
    // Worth noting here is that changes to the contents of this
    // are not guaranteed to be seen outside of a single thread. We never
    // expose it directly outside the RiakObject except via &quot;unsafe&quot; methods
    private volatile BinaryValue value;

    // Mutable collections
    private volatile RiakIndexes riakIndexes;
    private volatile RiakLinks links;
    private volatile RiakUserMetadata userMeta;

    // All immutable types
<span class="fc" id="L74">    private volatile String contentType = DEFAULT_CONTENT_TYPE;</span>
    private volatile String charset;
    private volatile String vtag;
    private volatile boolean isDeleted;
    private volatile boolean isModified;

    // This is annotated to that the UpdateValue command
    // can inject a vclock.
    @RiakVClock
    private volatile VClock vclock;

    private volatile long lastModified;

    /**
     * Constructs a new, empty RiakObject.
     */
    public RiakObject()
<span class="fc" id="L91">    {</span>
<span class="fc" id="L92">    }</span>

    // Methods For dealing with Value

    /**
     * Returns whether or not this RiakObject has a value
     *
     * @return true if the value has been asSet, false otherwise
     */
    public boolean hasValue()
    {
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        return value != null;</span>
    }

    /**
     * Returns the value of this RiakObject.
     *
     * @return the value of this RiakObject
     */
    public BinaryValue getValue()
    {
<span class="fc" id="L113">        return value;</span>
    }

    /**
     * Set the value for this RiakObject
     * &lt;p&gt;
     * Note that if {@link RiakObject#setContentType(java.lang.String)} is not
     * called a value of {@value #DEFAULT_CONTENT_TYPE} is used.
     * &lt;/p&gt;
     * &lt;br/&gt;&lt;b&gt;Thread Safety:&lt;/b&gt;&lt;br/&gt;
     * Unsafe modifications to the supplied BinaryValue's
     * underlying byte[] would be a bad thing.
     *
     * @param value the value to be stored in Riak.
     * @return a reference to this object.
     * @throws IllegalArgumentException if {@code value} is zero length.
     */
    public RiakObject setValue(BinaryValue value)
    {
<span class="pc bpc" id="L132" title="2 of 4 branches missed.">        if (value != null &amp;&amp; value.length() == 0)</span>
        {
<span class="nc" id="L134">            throw new IllegalArgumentException(&quot;value can not be zero length&quot;);</span>
        }
<span class="fc" id="L136">        this.value = value;</span>
<span class="fc" id="L137">        return this;</span>
    }

    /**
     * Get the vector clock for this RiakObject.
     *
     * @return The vector clock, or null if not set.
     */
    public VClock getVClock()
    {
<span class="fc" id="L147">        return vclock;</span>
    }

    /**
     * Set the vector clock for this RiakObject.
     *
     * @param vclock a vector clock.
     * @return a reference to this object.
     */
    public RiakObject setVClock(VClock vclock)
    {
<span class="fc" id="L158">        this.vclock = vclock;</span>
<span class="fc" id="L159">        return this;</span>
    }

    /**
     * Returns the version tag (if it is one of a asSet of siblings) for this RiakObject
     *
     * @return the vtag if present, otherwise {@code null}
     */
    public String getVTag()
    {
<span class="fc" id="L169">        return vtag;</span>
    }

    /**
     * Set the version tag for this RiakObject
     *
     * @param vtag a {@code String} representing the VTag for this RiakObject
     * @return a reference to this object
     * @throws IllegalArgumentException if {@code vtag} is zero length
     */
    public RiakObject setVTag(String vtag)
    {
<span class="pc bpc" id="L181" title="2 of 4 branches missed.">        if (vtag != null &amp;&amp; vtag.isEmpty())</span>
        {
<span class="nc" id="L183">            throw new IllegalArgumentException(&quot;vtag can not be zero length&quot;);</span>
        }
<span class="fc" id="L185">        this.vtag = vtag;</span>
<span class="fc" id="L186">        return this;</span>
    }

    /**
     * Returns the last modified time of this RiakObject.
     * &lt;p&gt;
     * The timestamp is returned as a {@code long} (Unix) epoch time.
     * &lt;/p&gt;
     *
     * @return The last modified time or {@code 0} if it has not been asSet.
     * @see RiakObject#setLastModified(long)
     */
    public long getLastModified()
    {
<span class="fc" id="L200">        return lastModified;</span>
    }

    /**
     * A {@code long} timestamp of milliseconds since the epoch to asSet as
     * the last modified date on this RiakObject.
     *
     * @param lastModified
     * @return a reference to this object
     */
    public RiakObject setLastModified(long lastModified)
    {
<span class="fc" id="L212">        this.lastModified = lastModified;</span>
<span class="fc" id="L213">        return this;</span>
    }

    /**
     * Returns the content type of the data payload (value) of this RiakObject
     * &lt;p&gt;
     * Due to Riak's HTTP API this is represented as a string suitable for
     * a HTTP {@code Content-Type} header.
     * &lt;/p&gt;
     *
     * @return a {@code String} representing the content type of this object's value
     * @see RiakObject#setVClock(com.basho.riak.client.api.cap.VClock)
     */
    public String getContentType()
    {
<span class="fc" id="L228">        return contentType;</span>
    }

    /**
     * Set the content type of the data payload (value) of the this RiakObject.
     * Please do not include a charset here, use {@link RiakObject#setCharset(String)} to declare one.
     * &lt;p&gt;
     * Due to Riak's HTTP API this is represented as a string suitable for
     * a HTTP {@code Content-Type} header.
     * &lt;/p&gt;
     *
     * @param contentType a {@code String} representing the content type of this object's value
     * @return a reference to this object
     * @see RiakObject#setValue(com.basho.riak.client.core.util.BinaryValue)
     */
    public RiakObject setContentType(String contentType)
    {
<span class="fc" id="L245">        this.contentType = contentType;</span>
<span class="fc" id="L246">        return this;</span>
    }

    /**
     * Determine if there is a charset set in either the charset or content-type settings.
     *
     * @return true if a charset is present, false otherwise.
     */
    public boolean hasCharset()
    {
<span class="fc bfc" id="L256" title="All 4 branches covered.">        return charset != null || CharsetUtils.hasCharset(this.contentType);</span>
    }

    /**
     * Get the charset for this RiakObject's content (value).
     * Will fetch from the RiakObject's charset setting, and failing that will attempt to get one from the content-type.
     * Defaults to UTF-8.
     * &lt;p&gt;
     * Due to Riak's HTTP API this is represented as a string suitable for
     * a HTTP {@code Content-Type} header.
     * &lt;/p&gt;
     *
     * @return The character asSet {@code String}
     * @see RiakObject#setCharset(java.lang.String)
     * @see RiakObject#setValue(com.basho.riak.client.core.util.BinaryValue)
     */
    public String getCharset()
    {
<span class="fc bfc" id="L274" title="All 2 branches covered.">        if (charset != null)</span>
        {
<span class="fc" id="L276">            return charset;</span>
        }

<span class="fc" id="L279">        return CharsetUtils.getDeclaredCharset(contentType);</span>
    }

    /**
     * Set the characterSet for this object's content (value).
     * &lt;p&gt;
     * Due to Riak's HTTP API this is represented as a string suitable for
     * a HTTP {@code Content-Type} header.
     * &lt;/p&gt;
     *
     * @param charset the {@link Charset} to be asSet
     * @return a reference to this object
     * @see RiakObject#setValue(com.basho.riak.client.core.util.BinaryValue)
     */
    public RiakObject setCharset(String charset)
    {
<span class="fc" id="L295">        this.charset = charset;</span>
<span class="fc" id="L296">        return this;</span>
    }

    // Indexes

    /**
     * Returns whether this RiakObject has secondary indexes (2i)
     *
     * @return {@code true} if indexes are present, {@code false} otherwise
     * @see &lt;a href=&quot;http://docs.basho.com/riak/latest/dev/advanced/2i/&quot;&gt;Riak Secondary Indexes&lt;/a&gt;
     */
    public boolean hasIndexes()
    {
<span class="pc bpc" id="L309" title="1 of 4 branches missed.">        return (riakIndexes != null &amp;&amp; !riakIndexes.isEmpty());</span>
    }

    /**
     * Returns the Secondary Indexes (2i) for this RiakObject
     * &lt;p&gt;
     * Any/all indexes for this {@code RiakObject} are encapsulated in the returned {@code RiakIndexes} object.
     * &lt;/p&gt;
     * &lt;br/&gt;&lt;b&gt;Thread Safety:&lt;/b&gt;&lt;br/&gt; The returned &lt;code&gt;RiakIndexes&lt;/code&gt; object encapsulates any/all
     * indexes for this &lt;code&gt;RiakObject}&lt;/code&gt;, is mutable, and thread safe. Any changes
     * are directly applied to this &lt;code&gt;RiakObject&lt;/code&gt;.
     *
     * @return the {@link RiakIndexes} that encapsulates any/all indexes for this RiakObject
     * @see &lt;a href=&quot;http://docs.basho.com/riak/latest/dev/advanced/2i/&quot;&gt;Riak Secondary Indexes&lt;/a&gt;
     */
    public synchronized RiakIndexes getIndexes()
    {
        // Lazy initialization of the internal container.
<span class="fc bfc" id="L327" title="All 2 branches covered.">        if (null == riakIndexes)</span>
        {
<span class="fc" id="L329">            riakIndexes = new RiakIndexes();</span>
        }
<span class="fc" id="L331">        return riakIndexes;</span>
    }

    // Links

    /**
     * Returns whether this RiakObject containsKeyKey links
     *
     * @return {@code true} if links are present, {@code false} otherwise
     */
    public boolean hasLinks()
    {
<span class="pc bpc" id="L343" title="1 of 4 branches missed.">        return (links != null &amp;&amp; !links.isEmpty());</span>
    }

    /**
     * Returns the RiakLinks for this RiakObject.
     * &lt;br/&gt;&lt;b&gt;Thread Safety:&lt;/b&gt;&lt;br/&gt; The returned &lt;code&gt;RiakLinks&lt;/code&gt; object encapsulates any/all
     * links for this &lt;code&gt;RiakObject&lt;/code&gt;, is mutable, and thread safe. Any changes
     * are directly applied to this &lt;code&gt;RiakObject&lt;/code&gt;.
     *
     * @return the {@link RiakIndexes} that encapsulates all/any links for this {@code RiakObject}
     */
    public synchronized RiakLinks getLinks()
    {
        // Lazy initialization of container
<span class="fc bfc" id="L357" title="All 2 branches covered.">        if (null == links)</span>
        {
<span class="fc" id="L359">            links = new RiakLinks();</span>
        }

<span class="fc" id="L362">        return links;</span>
    }

    // User Meta

    /**
     * Returns if there are any User Meta entries for this RiakObject
     *
     * @return {@code true} if user meta entries are present, {@code false} otherwise.
     */
    public boolean hasUserMeta()
    {
<span class="pc bpc" id="L374" title="3 of 4 branches missed.">        return userMeta != null &amp;&amp; !userMeta.isEmpty();</span>
    }

    /**
     * Returns the User Meta for this RiakObject
     * &lt;br/&gt;&lt;b&gt;Thread Safety:&lt;/b&gt;&lt;br/&gt;
     * The returned &lt;code&gt;RiakUserMetadata&lt;/code&gt; encapsulates any/all
     * user meta entries for this &lt;code&gt;RiakObject&lt;/code&gt;, is mutable, and thread safe. Any changes
     * are directly applied to this &lt;code&gt;RiakObject&lt;/code&gt;.
     *
     * @return the {@code RiakUserMetadata} that containsKeyKey any/all User Meta entries for this {@code RiakObject}
     */
    public synchronized RiakUserMetadata getUserMeta()
    {
        // Lazy initialization of container.
<span class="fc bfc" id="L389" title="All 2 branches covered.">        if (null == userMeta)</span>
        {
<span class="fc" id="L391">            userMeta = new RiakUserMetadata();</span>
        }

<span class="fc" id="L394">        return userMeta;</span>
    }

    /**
     * Returns whether or not this RiakObject is marked as being deleted (a tombstone)
     *
     * @return [{@code true} is this {@code RiakObject} is a tombstone, {@code false} otherwise
     */
    public boolean isDeleted()
    {
<span class="fc" id="L404">        return isDeleted;</span>
    }

    /**
     * Marks this RiakObject as being a tombstone in Riak
     *
     * @param isDeleted
     * @return a reference to this object
     */
    public RiakObject setDeleted(boolean isDeleted)
    {
<span class="nc" id="L415">        this.isDeleted = isDeleted;</span>
<span class="nc" id="L416">        return this;</span>
    }

    @Override
    public boolean equals(Object o)
    {
<span class="fc bfc" id="L422" title="All 2 branches covered.">        if (this == o)</span>
        {
<span class="fc" id="L424">            return true;</span>
        }
<span class="pc bpc" id="L426" title="2 of 4 branches missed.">        if (o == null || getClass() != o.getClass())</span>
        {
<span class="nc" id="L428">            return false;</span>
        }

<span class="fc" id="L431">        RiakObject that = (RiakObject) o;</span>

<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (isDeleted != that.isDeleted)</span>
        {
<span class="nc" id="L435">            return false;</span>
        }
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (isModified != that.isModified)</span>
        {
<span class="nc" id="L439">            return false;</span>
        }
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">        if (lastModified != that.lastModified)</span>
        {
<span class="nc" id="L443">            return false;</span>
        }
<span class="pc bpc" id="L445" title="4 of 6 branches missed.">        if (value != null ? !value.equals(that.value) : that.value != null)</span>
        {
<span class="nc" id="L447">            return false;</span>
        }
<span class="pc bpc" id="L449" title="4 of 6 branches missed.">        if (riakIndexes != null ? !riakIndexes.equals(that.riakIndexes) : that.riakIndexes != null)</span>
        {
<span class="nc" id="L451">            return false;</span>
        }
<span class="pc bpc" id="L453" title="4 of 6 branches missed.">        if (links != null ? !links.equals(that.links) : that.links != null)</span>
        {
<span class="nc" id="L455">            return false;</span>
        }
<span class="pc bpc" id="L457" title="4 of 6 branches missed.">        if (userMeta != null ? !userMeta.equals(that.userMeta) : that.userMeta != null)</span>
        {
<span class="nc" id="L459">            return false;</span>
        }
<span class="pc bpc" id="L461" title="4 of 6 branches missed.">        if (contentType != null ? !contentType.equals(that.contentType) : that.contentType != null)</span>
        {
<span class="nc" id="L463">            return false;</span>
        }
<span class="pc bpc" id="L465" title="4 of 6 branches missed.">        if (charset != null ? !charset.equals(that.charset) : that.charset != null)</span>
        {
<span class="nc" id="L467">            return false;</span>
        }
<span class="pc bpc" id="L469" title="4 of 6 branches missed.">        if (vtag != null ? !vtag.equals(that.vtag) : that.vtag != null)</span>
        {
<span class="nc" id="L471">            return false;</span>
        }
<span class="pc bpc" id="L473" title="4 of 6 branches missed.">        if (vclock != null ? !vclock.equals(that.vclock) : that.vclock != null)</span>
        {
<span class="nc" id="L475">            return false;</span>
        }

<span class="fc" id="L478">        return true;</span>
    }

    @Override
    public int hashCode()
    {
<span class="nc bnc" id="L484" title="All 2 branches missed.">        int result = value != null ? value.hashCode() : 0;</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">        result = 31 * result + (riakIndexes != null ? riakIndexes.hashCode() : 0);</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">        result = 31 * result + (links != null ? links.hashCode() : 0);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">        result = 31 * result + (userMeta != null ? userMeta.hashCode() : 0);</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">        result = 31 * result + (contentType != null ? contentType.hashCode() : 0);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">        result = 31 * result + (charset != null ? charset.hashCode() : 0);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">        result = 31 * result + (vtag != null ? vtag.hashCode() : 0);</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">        result = 31 * result + (isDeleted ? 1 : 0);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">        result = 31 * result + (isModified ? 1 : 0);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">        result = 31 * result + (vclock != null ? vclock.hashCode() : 0);</span>
<span class="nc" id="L494">        result = 31 * result + (int) (lastModified ^ (lastModified &gt;&gt;&gt; 32));</span>
<span class="nc" id="L495">        return result;</span>
    }

    @Override
    public String toString()
    {
<span class="nc" id="L501">        return &quot;RiakObject{&quot; +</span>
                &quot;contentType: &quot; + contentType +
                &quot;, value: &quot; + value +
                &quot;, riakIndexes: &quot; + riakIndexes +
                &quot;, links: &quot; + links +
                &quot;, userMeta: &quot; + userMeta +
                &quot;, vtag: &quot; + vtag +
                &quot;, isDeleted: &quot; + isDeleted +
                &quot;, isModified: &quot; + isModified +
                &quot;, vclock: &quot; + vclock +
                &quot;, lastModified: &quot; + lastModified +
                '}';
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>